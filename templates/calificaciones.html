{% extends 'base.html' %}
{% block title %}Calificaciones{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h4 class="fw-bold mb-0" style="color:var(--navy)">
    <i class="bi bi-pencil-square me-2"></i>Calificaciones
  </h4>
  <a href="{{ url_for('exportar') }}" class="btn btn-outline-navy btn-sm">
    <i class="bi bi-file-earmark-excel me-1"></i>Exportar
  </a>
</div>

{# ── Buscador ── #}
<div class="card mb-3">
  <div class="card-body py-2">
    <form method="GET" class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="mb-1">Buscar alumno</label>
        <input type="text" name="q" value="{{ q }}" class="form-control form-control-sm"
               placeholder="Apellido o nombre">
      </div>
      <div class="col-md-3">
        <label class="mb-1">Materia</label>
        <select name="materia_id" class="form-select form-select-sm">
          <option value="">Todas</option>
          {% for m in materias %}
          <option value="{{ m.id }}" {% if materia_id==m.id %}selected{% endif %}>
            {{ m.nombre }} ({{ m.anio_academico }})
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="mb-1">Año</label>
        <input type="number" name="anio" value="{{ anio or '' }}"
               class="form-control form-control-sm" placeholder="Ej: 2025">
      </div>
      <div class="col-auto">
        <button class="btn btn-sm btn-navy">
          <i class="bi bi-search me-1"></i>Buscar
        </button>
      </div>
      {% if q or materia_id or anio %}
      <div class="col-auto">
        <a href="{{ url_for('listar_calificaciones') }}"
           class="btn btn-sm btn-outline-secondary">
          <i class="bi bi-x"></i> Limpiar
        </a>
      </div>
      {% endif %}
    </form>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <i class="bi bi-table me-2"></i>{{ calificaciones|length }} registro(s)
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead>
          <tr>
            <th>Alumno</th><th>Materia</th><th>Año</th>
            <th>Prom.TPs</th><th>Parcial</th><th>R1</th><th>R2</th>
            <th>Final</th><th>Concepto</th><th>Acción</th>
          </tr>
        </thead>
        <tbody>
          {% for cal in calificaciones|sort(attribute='alumno.apellido') %}
          {% macro nota(v) %}
            {% if v is not none %}
              {% if v <= 3 %}
                <span class="grade-red">{{ "%.1f"|format(v) }}</span>
              {% else %}
                {{ "%.1f"|format(v) }}
              {% endif %}
            {% else %}—{% endif %}
          {% endmacro %}
          <tr {% if cal.final_forzado %}class="forced-final"{% endif %}>
            <td><strong>{{ cal.alumno.apellido }}</strong>, {{ cal.alumno.nombre }}</td>
            <td>{{ cal.materia.nombre }}</td>
            <td>{{ cal.materia.anio_academico }}</td>
            <td>{{ "%.2f"|format(cal.promedio_tps) if cal.promedio_tps is not none else '—' }}</td>
            <td>{{ nota(cal.parcial_nota) }}</td>
            <td>{{ nota(cal.r1_nota) }}</td>
            <td>{{ nota(cal.r2_nota) }}</td>
            <td>
              {{ nota(cal.final_nota) }}
              {% if cal.final_forzado %}
              <span class="badge ms-1" style="background:#9c27b0"
                    title="Final habilitado manualmente">⚠ Forzado</span>
              {% endif %}
            </td>
            <td>
              {% if cal.concepto_valor %}
              <span class="badge" style="background:var(--navy2)">
                {{ cal.concepto_valor }}
              </span>
              {% else %}—{% endif %}
            </td>
            <td>
              <a href="{{ url_for('editar_calificacion', aid=cal.alumno_id, mid=cal.materia_id) }}"
                 class="btn btn-sm btn-outline-navy" title="Ver/Editar">
                <i class="bi bi-pencil"></i>
              </a>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="10" class="text-center text-muted py-4">
              No hay calificaciones.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
