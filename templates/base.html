<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Sistema de Gestión Académica{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --navy:  #003366;
      --navy2: #00509e;
      --snow:  #fffafa;
      --red-grade: #cc0000;
    }
    body {
      background: var(--snow);
      color: #111;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      font-family: 'Segoe UI', sans-serif;
    }
    /* ── NAVBAR ── */
    .navbar { background: var(--navy) !important; }
    .navbar-brand { color: #fff !important; font-weight: 700; font-size: 1.1rem; }
    .nav-title { color: #c9d9f0; font-size: .9rem; }
    .navbar .btn-logout {
      border: 1px solid #c9d9f0;
      color: #c9d9f0;
      border-radius: 6px;
      padding: 4px 14px;
      font-size: .88rem;
      transition: .2s;
    }
    .navbar .btn-logout:hover { background: #c9d9f0; color: var(--navy); }
    /* ── DEMO BANNER ── */
    .demo-banner {
      background: #fff3cd; border-bottom: 2px solid #ffc107;
      text-align: center; padding: 6px;
      font-weight: 600; color: #856404; font-size: .9rem;
    }
    /* ── SIDEBAR ── */
    .sidebar {
      background: var(--navy);
      min-height: calc(100vh - 56px);
      width: 230px;
      min-width: 230px;
      padding-top: 1.5rem;
    }
    .sidebar a {
      display: flex; align-items: center; gap: .5rem;
      color: #c9d9f0; padding: .55rem 1.2rem;
      text-decoration: none; font-size: .93rem;
      border-left: 3px solid transparent;
      transition: .2s;
    }
    .sidebar a:hover, .sidebar a.active {
      background: rgba(255,255,255,.1);
      border-left-color: #6eb5ff;
      color: #fff;
    }
    .sidebar .section-label {
      color: #5b7fa6; font-size: .73rem; text-transform: uppercase;
      letter-spacing: 1px; padding: .9rem 1.2rem .3rem;
    }
    /* ── MAIN ── */
    .main-content { flex: 1; padding: 2rem; }
    /* ── CARDS ── */
    .card { border: 1px solid #d0dff0; border-radius: 10px; }
    .card-header {
      background: var(--navy); color: #fff;
      border-radius: 10px 10px 0 0 !important;
      font-weight: 600; padding: .75rem 1.25rem;
    }
    /* ── BUTTONS ── */
    .btn-navy {
      background: var(--navy); color: #fff; border: none;
      border-radius: 6px; padding: 6px 18px;
    }
    .btn-navy:hover { background: var(--navy2); color: #fff; }
    .btn-outline-navy {
      border: 1.5px solid var(--navy); color: var(--navy);
      border-radius: 6px; background: transparent;
    }
    .btn-outline-navy:hover { background: var(--navy); color: #fff; }
    /* ── TABLES ── */
    .table thead th { background: var(--navy); color: #fff; font-weight: 600; }
    .table-hover tbody tr:hover { background: #e8f0fb; }
    .grade-red { color: var(--red-grade) !important; font-weight: 700 !important; }
    /* ── FORCED FINAL ── */
    .forced-final { background: #f3e6ff; border-left: 4px solid #9c27b0; }
    /* ── FOOTER ── */
    footer {
      background: var(--navy); color: #8faecc;
      text-align: center; padding: 10px;
      font-size: .8rem; margin-top: auto;
    }
    /* ── ALERTS ── */
    .alert-danger  { border-left: 4px solid #dc3545; }
    .alert-success { border-left: 4px solid #198754; }
    .alert-warning { border-left: 4px solid #ffc107; }
    .alert-info    { border-left: 4px solid var(--navy); }
    /* ── FORM ── */
    .form-control:focus, .form-select:focus {
      border-color: var(--navy2); box-shadow: 0 0 0 .2rem rgba(0,80,158,.2);
    }
    label { font-weight: 500; color: var(--navy); }
  </style>
  {% block extra_head %}{% endblock %}
</head>
<body>

{# ── NAVBAR ── #}
<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <span class="navbar-brand">
      <i class="bi bi-mortarboard-fill me-2"></i>Sistema de Gestión Académica
    </span>
    {% if current_user.is_authenticated %}
    <span class="nav-title ms-3 d-none d-lg-block">
      Bienvenido, Prof. {{ current_user.nombre_completo }}
      {% if current_user.rol == 'admin' %}<span class="badge bg-warning text-dark ms-2">Admin</span>{% endif %}
      {% if current_user.rol == 'demo'  %}<span class="badge bg-secondary ms-2">DEMO</span>{% endif %}
    </span>
    <div class="ms-auto">
      <a href="{{ url_for('logout') }}" class="btn-logout text-decoration-none">
        <i class="bi bi-box-arrow-right me-1"></i>Cerrar Sesión
      </a>
    </div>
    {% endif %}
  </div>
</nav>

{# ── DEMO BANNER ── #}
{% if current_user.is_authenticated and current_user.rol == 'demo' %}
<div class="demo-banner">
  <i class="bi bi-eye me-1"></i>MODO DEMO — Los cambios <strong>no se guardan</strong>
</div>
{% endif %}

{# ── BODY ── #}
<div class="d-flex flex-grow-1">

  {% if current_user.is_authenticated %}
  {# ── SIDEBAR ── #}
  <nav class="sidebar d-none d-lg-block">
    <div class="section-label">Principal</div>
    <a href="{{ url_for('dashboard') }}" class="{% if request.endpoint=='dashboard' %}active{% endif %}">
      <i class="bi bi-speedometer2"></i> Dashboard
    </a>

    <div class="section-label">Gestión</div>
    <a href="{{ url_for('listar_materias') }}" class="{% if 'materia' in request.endpoint %}active{% endif %}">
      <i class="bi bi-journal-bookmark"></i> Materias
    </a>
    <a href="{{ url_for('listar_alumnos') }}" class="{% if 'alumno' in request.endpoint %}active{% endif %}">
      <i class="bi bi-people"></i> Alumnos
    </a>
    <a href="{{ url_for('listar_calificaciones') }}" class="{% if 'calificacion' in request.endpoint %}active{% endif %}">
      <i class="bi bi-pencil-square"></i> Calificaciones
    </a>
    <a href="{{ url_for('listar_inasistencias') }}" class="{% if 'inasistencia' in request.endpoint %}active{% endif %}">
      <i class="bi bi-calendar-x"></i> Inasistencias
    </a>
    <a href="{{ url_for('listar_reincorporatorios') }}" class="{% if 'reincorporatorio' in request.endpoint %}active{% endif %}">
      <i class="bi bi-arrow-repeat"></i> Reincorporatorios
    </a>

    {% if current_user.rol == 'admin' %}
    <div class="section-label">Administración</div>
    <a href="{{ url_for('admin_profesores') }}" class="{% if 'admin_profe' in request.endpoint %}active{% endif %}">
      <i class="bi bi-person-gear"></i> Profesores / Códigos
    </a>
    <a href="{{ url_for('exportar') }}">
      <i class="bi bi-file-earmark-excel"></i> Exportar Todo
    </a>
    {% else %}
    <div class="section-label">Herramientas</div>
    <a href="{{ url_for('exportar') }}">
      <i class="bi bi-file-earmark-excel"></i> Exportar Excel
    </a>
    {% endif %}

    <div class="section-label">Mi cuenta</div>
    <a href="{{ url_for('cambiar_password') }}">
      <i class="bi bi-key"></i> Cambiar Contraseña
    </a>
  </nav>
  {% endif %}

  {# ── MAIN CONTENT ── #}
  <main class="main-content flex-grow-1">
    {# Flash messages #}
    {% with msgs = get_flashed_messages(with_categories=true) %}
      {% for cat, msg in msgs %}
      <div class="alert alert-{{ cat }} alert-dismissible fade show" role="alert">
        {{ msg }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
      {% endfor %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>
</div>

<footer>Sistema de Gestión Académica diseñado y realizado por Fabián Belledi</footer>

{# ── MODAL GUARDAR CAMBIOS ── #}
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header" style="background:var(--navy);color:#fff;">
        <h6 class="modal-title mb-0"><i class="bi bi-question-circle me-2"></i>¿Guardar cambios?</h6>
      </div>
      <div class="modal-body text-center py-3">¿Deseas guardar los cambios realizados?</div>
      <div class="modal-footer justify-content-center">
        <button class="btn btn-sm btn-navy" id="confirmYes">Sí, guardar</button>
        <button class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">No</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ── Confirmación antes de guardar formularios ── */
document.addEventListener('DOMContentLoaded', () => {
  const forms = document.querySelectorAll('form[data-confirm]');
  forms.forEach(form => {
    form.addEventListener('submit', e => {
      e.preventDefault();
      const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
      document.getElementById('confirmYes').onclick = () => { modal.hide(); form.submit(); };
      modal.show();
    });
  });
});
</script>
{% block extra_js %}{% endblock %}
</body>
</html>
